<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>upload-test</title>
</head>
<body>
    <span>경과시간: <span id="elapsedTime"></span> ms</span> 
    <div id="image-area">

    </div>

    <div id="uploaded-area" style="border: 2px solid black;width: 100%; height:100px">
        <p>uploaded files here</p>
    </div>
    <div>
        <h1>멀티파일 드래그 앤 드롭 업로드</h1>
        <form method="post" enctype="multipart/form-data" id="multipart2" class="my-form">
            <input type="button" id="btnSubmitMulti2" value="멀티 파일 업로드"/>
        </form>
        <div id="drop-area" style="border: 2px solid black;width: 100%; height:400px">
            <p>Drag and drop files here</p>
        </div>
    </div>
    
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="./js/file.js"></script>
    <script src="./js/drop-file.js"></script>
    <script>
        FileDragDropUI.init();
        $("#btnSubmitMulti2").click(function (event) {
            event.preventDefault();
            const formData = new FormData()
            FileDragDropUI.uploadFiles.forEach(a=>{
                //console.log('list : ',a)
                testUpload(a)
                // 여
                //formData.append("file",a)
            });
            //uploadFile("http://localhost:9000/test/upload",formData)
        })

        const testUpload = (file) => {
            console.log('file : ',file)
            const startTime = new Date().getTime();

            const chunkSize = 1024 * 1024*30; // 30MB 청크
            const totalChunks = Math.ceil(file.size/chunkSize); //
            let currentChunk = 0;

            const uploadChunk = () => {
                const start  = currentChunk * chunkSize; //
                const end = Math.min(start+chunkSize, file.size);
                const chunk = file.slice(start,end)
                console.log('chunk'+currentChunk,chunk)

                const formData = new FormData();
                formData.append('chunk', chunk);
                formData.append('fileName', file.name);
                formData.append('chunkIndex', currentChunk);
                formData.append('totalChunks', totalChunks);

                $.ajax({             
                    type: "POST",          
                    url: "http://localhost:9000/test/uploadMassive",  
                    processData: false, // data 값을 쿼리 스트링으로 변환하지 않도록 설정
                    contentType: false, // formdata 가 알아서 contentType 작성해줌
                    cache: false, // 캐시 사용 안 함     
                    data: formData,                  
                    timeout: 600000,       
                    success: function (data,status) {
                        console.log('status : ',status); 
                        currentChunk++
                        if (currentChunk < totalChunks) {
                            uploadChunk();
                        }else {
                            console.log('uploadChunk Completed!!');
                        }

                    },          
                    error: function (e) {  
                        console.log("ERROR : ", e);     
                    }     
                });
            }



            uploadChunk();
            const endTime = new Date().getTime();
            const elapsedTime = endTime - startTime;
            document.getElementById("elapsedTime").textContent = elapsedTime;
        }


   
        const uploadFile = (url,formData) => {
            const startTime = new Date().getTime();
            $.ajax({             
                type: "POST",          
                url: url,  
                processData: false, // data 값을 쿼리 스트링으로 변환하지 않도록 설정
                contentType: false, // formdata 가 알아서 contentType 작성해줌
                cache: false, // 캐시 사용 안 함     
                data: formData,                  
                timeout: 600000,       
                success: function (data) { 
                    alert(data);           
                    $("#btnSubmit").prop("disabled", false);  
                    createUploadedFiles();   
                    FileDragDropUI.initialize(); 
                    
                    
                },          
                error: function (e) {  
                    console.log("ERROR : ", e);     
                    $("#btnSubmit").prop("disabled", false);    
                    alert("fail");   
                    FileDragDropUI.initialize();    
                }     
            });
        }
    
        function createUploadedFiles() {
            let uploadedArea = document.getElementById('uploaded-area');
            uploadedArea.textContent = '';
            FileDragDropUI.uploadFiles.forEach(file => {
                let div = document.createElement('div');
                div.textContent = file.name;
                
                let btnDownload = document.createElement('button');
                btnDownload.textContent = 'Download';
                btnDownload.value=
                btnDownload.addEventListener('click', (e) => {
                    e.preventDefault();
                    downloadFile("http://localhost:9000/test/download",file.name)
                });
                div.appendChild(btnDownload);

                let btnView = document.createElement('button');
                btnView.textContent = 'View';
                btnView.addEventListener('click', (e) => {
                    e.preventDefault();
                    viewFile("http://localhost:9000/test/view",file.name);
                });
                div.appendChild(btnView);

                
                uploadedArea.appendChild(div);
            });
        };

        

    </script>
</body>
</html>
